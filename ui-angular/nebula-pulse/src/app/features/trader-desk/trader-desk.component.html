<div class="flex flex-col gap-6">
	<section ktuiCard="glass" class="rounded-3xl p-6 shadow-lg shadow-purple-500/15">
		<div class="flex flex-wrap items-start justify-between gap-4">
			<div>
				<h2 class="text-sm font-semibold uppercase tracking-[0.35em] text-slate-300">Risk Budget</h2>
				<p class="text-xs text-slate-500">Live limits from orchestrator FREE mode</p>
			</div>
			<button type="button" ktuiPill="primary" class="shrink-0" (click)="refreshLimits()">
				<span>Refresh</span>
			</button>
		</div>

		@if (loadingLimits()) {
			<p class="mt-4 text-xs text-slate-400">Loading limits…</p>
		} @else if (riskLimits()) {
			<div class="mt-6 grid gap-5 lg:grid-cols-[minmax(0,1fr)_260px]">
				<div class="flex flex-col gap-5">
					<div class="grid gap-4 text-sm sm:grid-cols-3">
						<div class="rounded-2xl border border-white/5 bg-white/5 p-3">
							<p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">Per trade</p>
							<p class="mt-1 text-lg font-semibold text-cyan-200">{{ riskLimits()!.per_trade_pct | percent:'1.2-2' }}</p>
						</div>
						<div class="rounded-2xl border border-white/5 bg-white/5 p-3">
							<p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">Daily stop</p>
							<p class="mt-1 text-lg font-semibold text-rose-200">{{ riskLimits()!.daily_stop_pct | percent:'1.1-2' }}</p>
						</div>
						<div class="rounded-2xl border border-white/5 bg-white/5 p-3">
							<p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">Weekly stop</p>
							<p class="mt-1 text-lg font-semibold text-rose-200">{{ riskLimits()!.weekly_stop_pct | percent:'1.1-2' }}</p>
						</div>
					</div>

					@if (riskUsage()) {
						<div class="rounded-2xl border border-white/5 bg-slate-950/70 p-4">
							<div class="flex flex-wrap items-center justify-between gap-2">
								<p class="text-xs uppercase tracking-[0.3em] text-slate-400">Risk usage</p>
								<p class="text-xs font-semibold" [ngClass]="riskUsage()!.overLimit ? 'text-rose-200' : 'text-slate-300'">
									{{ riskUsage()!.used | percent:'1.2-2' }} / {{ riskUsage()!.capacity | percent:'1.2-2' }}
								</p>
							</div>
							<div class="mt-3 h-2 w-full rounded-full bg-slate-800/80">
								<div class="h-2 rounded-full bg-gradient-to-r from-cyan-400 via-amber-300 to-rose-400" [style.width.%]="riskUsage()!.width"></div>
							</div>
							<p class="mt-2 text-xs text-slate-500">{{ riskUsage()!.percent }}% of allocation</p>
						</div>
					}
				</div>

				<div class="rounded-2xl border border-white/10 bg-white/5 p-4 backdrop-blur">
					<div class="flex items-center justify-between gap-3">
						<h3 class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Safety Controls</h3>
						<span class="text-xs font-semibold uppercase tracking-[0.3em]" [ngClass]="{
							'text-emerald-300': panicState() === 'idle',
							'text-amber-200': panicState() === 'armed',
							'text-rose-200': panicState() === 'tripped'
						}">{{ panicState() }}</span>
					</div>
					<div class="mt-3 flex flex-col gap-3">
						@if (panicState() === 'idle') {
							<button type="button" ktuiPill="danger" class="self-start" (click)="armPanic()">
								<span>Arm Panic</span>
							</button>
						} @else if (panicState() === 'armed') {
							<div class="flex flex-wrap items-center gap-2">
								<button type="button" ktuiPill="danger" (click)="triggerPanic()">
									<span>Confirm Panic</span>
								</button>
								<button type="button" ktuiPill="muted" (click)="cancelPanic()">
									<span>Cancel</span>
								</button>
							</div>
						} @else {
							<p class="text-xs text-rose-200">Panic fired — reconnect once orchestrator is safe.</p>
						}
						@if (panicFeedback()) {
							<p class="text-[11px] text-slate-400">{{ panicFeedback() }}</p>
						}
					</div>
				</div>
			</div>
		} @else if (limitsError()) {
			<p class="mt-4 rounded-xl border border-rose-500/40 bg-rose-500/10 px-3 py-2 text-xs text-rose-200">
				{{ limitsError() }}
			</p>
		}
	</section>

	<section ktuiCard="accent" class="relative overflow-hidden rounded-3xl p-6">
		<div class="grid gap-6 lg:grid-cols-2">
			<div>
				<h3 class="text-xs uppercase tracking-[0.35em] text-slate-400">Latest Signal</h3>
				@if (signalRows().length) {
					<p class="mt-3 text-xl font-semibold text-slate-100">{{ signalRows()[0].instrument }}</p>
					<p class="text-sm text-slate-400">{{ signalRows()[0].strategy }} · {{ signalRows()[0].ts | date:'shortTime' }}</p>
					<div class="mt-4 grid gap-2 text-sm sm:grid-cols-2">
						<p class="font-semibold" [ngClass]="scoreColor(signalRows()[0].score)">
							Score {{ signalRows()[0].score | number:'1.2-2' }}
						</p>
						<p class="text-slate-300">{{ signalRows()[0].recommended.side }} @ {{ signalRows()[0].recommended.entry | number:'1.2-2' }}</p>
						<p class="text-xs uppercase tracking-[0.2em] text-slate-500 sm:col-span-2">Stop {{ signalRows()[0].recommended.stop | number:'1.2-2' }} · Target {{ signalRows()[0].recommended.target ?? '—' }}</p>
					</div>
				} @else {
					<p class="mt-4 text-sm text-slate-400">Waiting for signals…</p>
				}
			</div>
			<div class="rounded-2xl border border-white/5 bg-slate-950/80 p-5">
				<h3 class="text-xs uppercase tracking-[0.35em] text-slate-400">Latest Execution</h3>
				@if (executionRows().length) {
					<p class="mt-3 text-xl font-semibold text-slate-100">{{ executionRows()[0].instrument }}</p>
					<p class="text-sm text-slate-400">{{ executionRows()[0].price | number:'1.2-2' }} · {{ executionRows()[0].qty | number:'1.2-2' }} · {{ executionRows()[0].status }}</p>
				} @else {
					<p class="mt-4 text-sm text-slate-400">No fills yet.</p>
				}
			</div>
		</div>
	</section>

	<div class="grid gap-6 xl:grid-cols-2">
		<section ktuiCard="surface" class="rounded-3xl p-6 shadow-lg shadow-cyan-500/10">
			<div class="flex flex-wrap items-center justify-between gap-3">
				<h2 class="text-sm font-semibold uppercase tracking-[0.35em] text-slate-300">Signals</h2>
				<span class="text-xs text-slate-500">Showing {{ signalRows().length }} most recent</span>
			</div>
			<div class="mt-4 overflow-hidden rounded-2xl border border-white/5">
				<div class="overflow-x-auto">
					<table class="min-w-[760px] divide-y divide-white/10 text-left text-sm">
						<thead class="bg-white/5 text-xs uppercase tracking-[0.3em] text-slate-400">
							<tr>
								<th class="px-4 py-3">Timestamp</th>
								<th class="px-4 py-3">Instrument</th>
								<th class="px-4 py-3">Strategy</th>
								<th class="px-4 py-3">Score</th>
								<th class="px-4 py-3">Side</th>
								<th class="px-4 py-3">Entry</th>
								<th class="px-4 py-3">Stop</th>
								<th class="px-4 py-3">Target</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-white/5">
							@for (row of signalRows(); track trackSignal($index, row); let idx = $index) {
								<tr class="bg-slate-900/40 hover:bg-slate-900/70">
									<td class="px-4 py-3 text-xs text-slate-400">{{ row.ts | date:'short' }}</td>
									<td class="px-4 py-3 font-semibold">{{ row.instrument }}</td>
									<td class="px-4 py-3 text-xs tracking-[0.2em] text-slate-400">{{ row.strategy }}</td>
									<td class="px-4 py-3 font-semibold" [ngClass]="scoreColor(row.score)">{{ row.score | number:'1.2-2' }}</td>
									<td class="px-4 py-3">
										<span [ktuiBadge]="row.recommended.side === 'BUY' ? 'success' : 'danger'">{{ row.recommended.side }}</span>
									</td>
									<td class="px-4 py-3 text-sm text-slate-200">{{ row.recommended.entry | number:'1.2-2' }}</td>
									<td class="px-4 py-3 text-sm text-slate-200">{{ row.recommended.stop | number:'1.2-2' }}</td>
									<td class="px-4 py-3 text-sm text-slate-200">{{ row.recommended.target ?? '—' }}</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</section>

		<section ktuiCard="glass" class="rounded-3xl p-6 shadow-lg shadow-cyan-500/10">
			<div class="flex flex-wrap items-center justify-between gap-3">
				<h2 class="text-sm font-semibold uppercase tracking-[0.35em] text-slate-300">Executions</h2>
				<span class="text-xs text-slate-500">Showing {{ executionRows().length }} most recent</span>
			</div>
			<div class="mt-4 overflow-hidden rounded-2xl border border-white/5">
				<div class="overflow-x-auto">
					<table class="min-w-[640px] divide-y divide-white/10 text-left text-sm">
						<thead class="bg-white/5 text-xs uppercase tracking-[0.3em] text-slate-400">
							<tr>
								<th class="px-4 py-3">Timestamp</th>
								<th class="px-4 py-3">Instrument</th>
								<th class="px-4 py-3">Price</th>
								<th class="px-4 py-3">Quantity</th>
								<th class="px-4 py-3">Status</th>
								<th class="px-4 py-3">Liquidity</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-white/5">
							@for (row of executionRows(); track trackExecution($index, row)) {
								<tr class="bg-slate-900/30 hover:bg-slate-900/60">
									<td class="px-4 py-3 text-xs text-slate-400">{{ row.ts | date:'mediumTime' }}</td>
									<td class="px-4 py-3 font-medium">{{ row.instrument }}</td>
									<td class="px-4 py-3 text-sm text-slate-200">{{ row.price | number:'1.2-2' }}</td>
									<td class="px-4 py-3 text-sm text-slate-200">{{ row.qty | number:'1.2-2' }}</td>
									<td class="px-4 py-3 text-xs font-semibold">
										<span [ktuiBadge]="row.status === 'FILLED' || row.status === 'PARTIAL' ? 'success' : row.status === 'NEW' ? 'info' : 'danger'">{{ row.status }}</span>
									</td>
									<td class="px-4 py-3 text-xs text-slate-400">{{ row.liquidity ?? '—' }}</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</section>
	</div>
</div>
